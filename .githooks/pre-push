#!/bin/sh
set -e

# Pre-push hook: ensure frontend lockfile is in sync with package.json
# This prevents pushes that would pass local non-frozen installs but fail CI.

if [ -d frontend ]; then
  if command -v bun >/dev/null 2>&1; then
	echo "Checking frontend lockfile with 'bun install --frozen-lockfile'..."
	cd frontend
	if ! bun install --frozen-lockfile >/dev/null 2>&1; then
	  printf "\nERROR: frontend lockfile is out of sync with package.json.\n"
	  printf "Run 'cd frontend && bun install' and commit the updated lockfile, or fix package.json.\n"
	  exit 1
	fi
	cd - >/dev/null 2>&1 || true
  else
	echo "bun not found; skipping frontend lockfile check"
  fi
fi

# Run e2e smoke pre-push (skippable via SKIP_E2E_PRE_PUSH=1). This will attempt
# to bring up the e2e compose stack if a test Postgres isn't reachable.
if [ "${SKIP_E2E_PRE_PUSH:-}" != "1" ]; then
	if command -v bash >/dev/null 2>&1; then
		echo "Running quick e2e smoke (skippable with SKIP_E2E_PRE_PUSH=1)..."
		# run the project script which will start compose e2e stack if needed
		if ! ./scripts/run-e2e-smoke.sh; then
			echo "Pre-push e2e smoke failed. To skip locally set SKIP_E2E_PRE_PUSH=1 and re-push."
			exit 1
		fi
	else
		echo "bash not found; skipping e2e pre-push smoke"
	fi
else
	echo "SKIP_E2E_PRE_PUSH=1 set â€” not running e2e smoke"
fi

exit 0
