#!/bin/sh
set -e

# Pre-push: fast lint + type-check + short unit tests only.
# Full suite (vitest, go -race, e2e, docker build) runs in CI.
# Skip entirely: SKIP_PRE_PUSH=1 git push

if [ "${SKIP_PRE_PUSH:-}" = "1" ]; then
  echo "SKIP_PRE_PUSH=1 â€” skipping pre-push checks"
  exit 0
fi

echo "ðŸš€ Running pre-push checks (lint + type-check + short tests)..."

if [ -d frontend ] && command -v bun >/dev/null 2>&1; then
  cd frontend && bun install --frozen-lockfile --silent
  echo "  â†’ biome lint..."
  bun --bun biome check src || { printf "\nERROR: Frontend lint failed.\n"; exit 1; }
  echo "  â†’ tsc..."
  bun --bun tsc --noEmit || { printf "\nERROR: Frontend type-check failed.\n"; exit 1; }
  cd ..
fi

if [ -d backend ]; then
  echo "  â†’ go test -short..."
  cd backend && go test ./... -short || { printf "\nERROR: Backend short tests failed.\n"; exit 1; }
  cd ..
fi

echo "âœ… Pre-push checks passed (full suite runs in CI)."
exit 0
