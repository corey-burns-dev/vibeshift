#!/bin/sh

# Sanctum Pro-grade Pre-commit Hook
# 1. Formats and Lints Backend (Go)
# 2. Formats and Lints Frontend (Biome)
# 3. Re-stages only modified files

echo "ğŸš€ Running pre-commit quality checks..."

# --- 1. Backend Quality ---
echo "ğŸ¨ Formatting and ğŸ” Linting Go code..."
# Run formatting first
make fmt
if [ $? -ne 0 ]; then
    echo "âŒ Go formatting failed."
    exit 1
fi

# Run linter
make lint
if [ $? -ne 0 ]; then
    echo "âŒ Backend linting failed. Please fix errors before committing."
    exit 1
fi

# --- 2. Frontend Quality ---
echo "ğŸ¨ Formatting and ğŸ” Linting frontend code (Biome)..."
# 'make lint-frontend' runs 'biome check --write', which handles both
make lint-frontend
if [ $? -ne 0 ]; then
    echo "âŒ Frontend quality checks failed."
    exit 1
fi

# --- 3. Smart Re-staging ---
# Only re-stage files that were already staged but modified by fmt/lint
echo "ğŸ“¦ Re-staging formatted files..."
git diff --name-only --cached | xargs git add

echo "âœ… All checks passed! Proceeding with commit."
exit 0