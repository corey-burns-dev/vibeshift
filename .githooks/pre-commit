#!/bin/sh

# Sanctum Pro-grade Pre-commit Hook
# 1. Regenerate swagger
# 2. Formats and Lints Backend (Go)
# 3. Formats and Lints Frontend (Biome)
# 4. Re-stages only modified files

echo "ğŸš€ Running pre-commit quality checks..."

# --- 1. Swagger Generation ---
echo "ğŸ“– Regenerating swagger docs..."
if command -v make >/dev/null 2>&1; then
  if make swagger; then
    if git status --porcelain | grep -q "backend/docs/swagger.yaml"; then
      git add backend/docs/swagger.yaml
      echo "[pre-commit] backend/docs/swagger.yaml updated"
    fi
  else
    echo "âš ï¸ make swagger failed â€” continue"
  fi
fi

# --- 2. Backend Quality ---
echo "ğŸ¨ Formatting and ğŸ” Linting Go code..."
make fmt
if [ $? -ne 0 ]; then
    echo "âŒ Go formatting failed."
    exit 1
fi

make lint
if [ $? -ne 0 ]; then
    echo "âŒ Backend linting failed. Please fix errors before committing."
    exit 1
fi

# --- 3. Frontend Quality ---
echo "ğŸ¨ Formatting and ğŸ” Linting frontend code (Biome)..."
# Now uses --write as updated in Makefile
make lint-frontend
if [ $? -ne 0 ]; then
    echo "âŒ Frontend quality checks failed."
    exit 1
fi

make type-check-frontend
if [ $? -ne 0 ]; then
    echo "âŒ Frontend type checking failed. Please fix errors before committing."
    exit 1
fi

# --- 4. Smart Re-staging ---
# Only re-stage files that were already staged but modified by fmt/lint
echo "ğŸ“¦ Re-staging formatted files..."
# Get list of files that are both staged and modified in working directory
MODIFIED_STAGED=$(git diff --name-only --cached)
if [ -n "$MODIFIED_STAGED" ]; then
    echo "$MODIFIED_STAGED" | xargs git add
fi

echo "âœ… All checks passed! Proceeding with commit."
exit 0
