#!/bin/sh
set -e

echo "ðŸš€ pre-commit: running quality checks..."

# 1) Swagger generation (non-blocking)
echo "[pre-commit] swagger generation (non-blocking)"
if command -v make >/dev/null 2>&1; then
  if make swagger; then
    if git status --porcelain | grep -q "backend/docs/swagger.yaml"; then
      git add backend/docs/swagger.yaml
      echo "[pre-commit] staged updated backend/docs/swagger.yaml"
    fi
  else
    echo "[pre-commit] make swagger failed â€” continuing"
  fi
else
  echo "[pre-commit] make not found â€” skipping swagger generation"
fi

# 2) Backend fmt + lint (blocking)
echo "[pre-commit] backend fmt + lint"
make fmt
make lint

# 3) Frontend checks (blocking)
echo "[pre-commit] frontend lint/format"
make lint-frontend

# 4) Re-stage anything that formatting changed (only for already-staged files)
echo "[pre-commit] re-staging formatted files"
git diff --name-only --cached | xargs git add || true

echo "âœ… pre-commit: all checks passed"
exit 0
