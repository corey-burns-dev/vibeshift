name: GHCR Container Cleanup

on:
    # Run after every image push so storage is trimmed immediately
    workflow_run:
        workflows: ["Push Docker Images"]
        types: [completed]
    # Daily safety net
    schedule:
        - cron: "0 3 * * *"
    workflow_dispatch:
        inputs:
            keep_versions:
                description: "Number of most-recent versions to keep per image"
                required: false
                default: "2"

permissions:
    contents: read
    packages: write

jobs:
    cleanup:
        name: Cleanup old GHCR container package versions
        runs-on: ubuntu-latest
        steps:
            - name: Delete old container package versions
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  OWNER: ${{ github.repository_owner }}
                  KEEP_VERSIONS: ${{ github.event.inputs.keep_versions || '2' }}
              run: |
                  set -euo pipefail
                  API='https://api.github.com'
                  PKGS='playwright frontend backend'

                  # detect owner type (User vs Organization) so we use correct API path
                  owner_type=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GITHUB_TOKEN" "$API/users/$OWNER" | jq -r '.type // empty')
                  if [ "$owner_type" = "Organization" ]; then
                    PKG_BASE="$API/orgs/$OWNER/packages/container"
                  else
                    PKG_BASE="$API/users/$OWNER/packages/container"
                  fi

                  for pkg in $PKGS; do
                    echo "Checking package: $pkg â€” keeping $KEEP_VERSIONS most recent versions"
                    resp=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GITHUB_TOKEN" "$PKG_BASE/$pkg/versions?per_page=100")

                    # Sort newest-first, skip the first KEEP_VERSIONS, collect IDs to delete
                    # Always protect versions tagged 'latest' regardless of position
                    ids_to_delete=$(echo "$resp" | jq -r --argjson keep "$KEEP_VERSIONS" '
                      sort_by(.created_at) | reverse
                      | to_entries
                      | map(select(
                          .key >= $keep and
                          ((.value.metadata.container.tags // []) | index("latest") | not)
                        ))
                      | .[].value.id
                    ')

                    if [ -z "$ids_to_delete" ]; then
                      echo "Nothing to delete for $pkg"
                      continue
                    fi

                    for id in $ids_to_delete; do
                      echo "Deleting $pkg version $id"
                      curl -s -X DELETE \
                        -H "Accept: application/vnd.github+json" \
                        -H "Authorization: Bearer $GITHUB_TOKEN" \
                        "$PKG_BASE/$pkg/versions/$id" || true
                    done
                  done
