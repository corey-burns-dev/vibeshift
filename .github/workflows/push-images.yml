name: Push Docker Images

on:
    # Trigger after the main `CI` workflow completes successfully for branch pushes
    workflow_run:
        workflows: ["CI"]
        types: [completed]
    # Also allow pushing immutable images for tag-based releases (v* tags)
    push:
        tags: ["v*"]
    # Manual run for re-pushing or debugging
    workflow_dispatch: {}

concurrency:
    group: push-images-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read
    packages: write

jobs:
    build-and-push:
        name: Build and Push Images
        runs-on: ubuntu-latest
        # If this was started by `workflow_run`, only proceed when the upstream CI succeeded.
        if: >
            github.event_name != 'workflow_run' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  # When triggered by `workflow_run` we want to check out the commit that CI ran on
                  ref: ${{ github.event.workflow_run.head_sha || github.ref }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Lowercase repo name
              id: repo
              run: echo "name=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push Backend
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: Dockerfile
                  push: true
                  tags: |
                      ghcr.io/${{ steps.repo.outputs.name }}/backend:latest
                      ghcr.io/${{ steps.repo.outputs.name }}/backend:${{ github.sha }}
                      ${{ startsWith(github.ref, 'refs/tags/') && format('ghcr.io/{0}/backend:{1}', steps.repo.outputs.name, github.ref_name) || '' }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build and push Frontend
              uses: docker/build-push-action@v5
              with:
                  context: ./frontend
                  file: frontend/Dockerfile
                  push: true
                  tags: |
                      ghcr.io/${{ steps.repo.outputs.name }}/frontend:latest
                      ghcr.io/${{ steps.repo.outputs.name }}/frontend:${{ github.sha }}
                      ${{ startsWith(github.ref, 'refs/tags/') && format('ghcr.io/{0}/frontend:{1}', steps.repo.outputs.name, github.ref_name) || '' }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build and push Playwright e2e image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: frontend/Dockerfile.e2e
                  push: true
                  tags: |
                      ghcr.io/${{ steps.repo.outputs.name }}/playwright:latest
                      ghcr.io/${{ steps.repo.outputs.name }}/playwright:${{ github.sha }}
                      ${{ startsWith(github.ref, 'refs/tags/') && format('ghcr.io/{0}/playwright:{1}', steps.repo.outputs.name, github.ref_name) || '' }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
