name: Push Docker Images

on:
    # Trigger after the main `CI` workflow completes successfully for branch pushes
    workflow_run:
        workflows: ["CI"]
        types: [completed]
    # Also allow pushing immutable images for tag-based releases (v* tags)
    push:
        tags: ['v*']
    # Manual run for re-pushing or debugging
    workflow_dispatch: {}

concurrency:
    group: push-images-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read
    packages: write

jobs:
        build-and-push:
                name: Build and Push Images
                runs-on: ubuntu-latest
                # If this was started by `workflow_run`, only proceed when the upstream CI succeeded.
                if: >
                    github.event_name != 'workflow_run' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
        steps:
                        - uses: actions/checkout@v4
                            with:
                                # When triggered by `workflow_run` we want to check out the commit that CI ran on
                                ref: ${{ github.event.workflow_run.head_sha || github.ref }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: |
                      ghcr.io/${{ github.repository }}/backend
                      ghcr.io/${{ github.repository }}/frontend
                      ghcr.io/${{ github.repository }}/playwright
                  tags: |
                      type=raw,value=latest
                      type=sha,format=long

            - name: Build and push Backend
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: Dockerfile
                  push: true
                  tags: |
                      ghcr.io/${{ github.repository }}/backend:latest
                      ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build and push Frontend
              uses: docker/build-push-action@v5
              with:
                  context: ./frontend
                  file: frontend/Dockerfile
                  push: true
                  tags: |
                      ghcr.io/${{ github.repository }}/frontend:latest
                      ghcr.io/${{ github.repository }}/frontend:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build and push Playwright e2e image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: frontend/Dockerfile.e2e
                  push: true
                  tags: |
                      ghcr.io/${{ github.repository }}/playwright:latest
                      ghcr.io/${{ github.repository }}/playwright:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
