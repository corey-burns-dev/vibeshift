name: PR Body Sync

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
  push:
    branches-ignore:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  sync-pr-body:
    name: Sync PR Body From Commits
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Locate open PR for branch
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            echo "has_pr=true" >> "$GITHUB_OUTPUT"
            echo "pr_number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
            echo "base_ref=${{ github.event.pull_request.base.ref }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BRANCH="${GITHUB_REF_NAME}"
          HEAD_REF="${GITHUB_REPOSITORY_OWNER}:${BRANCH}"
          PR_NUMBER="$(gh pr list --head "$HEAD_REF" --state open --json number --jq '.[0].number // empty')"

          if [ -z "$PR_NUMBER" ]; then
            echo "No open PR found for branch '$BRANCH'; skipping."
            echo "has_pr=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BASE_REF="$(gh pr view "$PR_NUMBER" --json baseRefName --jq '.baseRefName')"

          echo "has_pr=true" >> "$GITHUB_OUTPUT"
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "base_ref=$BASE_REF" >> "$GITHUB_OUTPUT"

      - name: Generate PR body
        if: steps.pr.outputs.has_pr == 'true'
        run: |
          set -euo pipefail
          git fetch origin "${{ steps.pr.outputs.base_ref }}" --depth=1
          bash scripts/gen_pr_body.sh "origin/${{ steps.pr.outputs.base_ref }}" PR_BODY.md

      - name: Update PR body
        if: steps.pr.outputs.has_pr == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh pr edit "${{ steps.pr.outputs.pr_number }}" --body-file PR_BODY.md
          echo "Updated PR #${{ steps.pr.outputs.pr_number }}"
