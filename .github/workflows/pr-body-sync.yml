name: PR Body Sync

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
  push:
    branches-ignore:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  sync-pr-body:
    name: Sync PR Body From Commits
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Locate open PR for branch
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          set -euo pipefail

          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            echo "has_pr=true" >> "$GITHUB_OUTPUT"
            echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
            echo "base_ref=$BASE_REF" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BRANCH="${GITHUB_REF_NAME}"
          HEAD_REF="${GITHUB_REPOSITORY_OWNER}:${BRANCH}"
          PR_NUMBER_LIST="$(gh pr list --head "$HEAD_REF" --state open --json number --jq '.[0].number // empty')"

          if [ -z "$PR_NUMBER_LIST" ]; then
            echo "No open PR found for branch '$BRANCH'; skipping."
            echo "has_pr=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BASE_REF_LIST="$(gh pr view "$PR_NUMBER_LIST" --json baseRefName --jq '.baseRefName')"

          echo "has_pr=true" >> "$GITHUB_OUTPUT"
          echo "pr_number=$PR_NUMBER_LIST" >> "$GITHUB_OUTPUT"
          echo "base_ref=$BASE_REF_LIST" >> "$GITHUB_OUTPUT"

      - name: Generate PR body
        if: steps.pr.outputs.has_pr == 'true'
        env:
          BASE_REF: ${{ steps.pr.outputs.base_ref }}
        run: |
          set -euo pipefail
          git fetch origin "$BASE_REF" --depth=1
          bash scripts/gen_pr_body.sh "origin/$BASE_REF" PR_BODY.md

      - name: Update PR body
        if: >
          steps.pr.outputs.has_pr == 'true' &&
          (
            github.event_name != 'pull_request' ||
            (
              github.actor != 'dependabot[bot]' &&
              github.event.pull_request.head.repo.full_name == github.repository
            )
          )
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
        run: |
          set -euo pipefail
          gh pr edit "$PR_NUMBER" --body-file PR_BODY.md
          echo "Updated PR #$PR_NUMBER"

      - name: Skip PR body update in read-only PR contexts
        if: >
          steps.pr.outputs.has_pr == 'true' &&
          github.event_name == 'pull_request' &&
          (
            github.actor == 'dependabot[bot]' ||
            github.event.pull_request.head.repo.full_name != github.repository
          )
        env:
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
        run: |
          echo "Skipping PR #$PR_NUMBER body update: read-only token context (Dependabot or fork PR)."
