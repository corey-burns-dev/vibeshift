name: Auto Create PR

on:
  push:
    branches-ignore:
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-pr:
    name: Create PR On Push
    if: github.actor != 'github-actions[bot]' && github.ref_name != github.event.repository.default_branch
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Create PR if missing
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH_NAME: ${{ github.ref_name }}
          BASE_BRANCH: ${{ github.event.repository.default_branch }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Skip tag pushes.
          if [ "${GITHUB_REF_TYPE}" != "branch" ]; then
            echo "Not a branch push; skipping."
            exit 0
          fi

          HEAD_REF="${GITHUB_REPOSITORY_OWNER}:${BRANCH_NAME}"
          OPEN_PR_NUMBER="$(gh pr list --repo "$REPO" --state open --head "$HEAD_REF" --json number --jq '.[0].number // empty')"

          if [ -n "$OPEN_PR_NUMBER" ]; then
            echo "Open PR already exists: #$OPEN_PR_NUMBER"
            exit 0
          fi

          TITLE="$(git log -1 --pretty=%s)"
          BODY="Automated PR created from push to \\\`$BRANCH_NAME\\\` targeting \\\`$BASE_BRANCH\\\`."

          # Attempt to create PR and capture output; if gh reports it already exists, treat as success.
          set +e
          OUTPUT="$(gh pr create \
            --repo "$REPO" \
            --base "$BASE_BRANCH" \
            --head "$BRANCH_NAME" \
            --title "$TITLE" \
            --body "$BODY" 2>&1)"
          rc=$?
          set -e

          if [ $rc -ne 0 ]; then
            # If gh CLI indicates the PR already exists, return success and print message.
            if echo "$OUTPUT" | grep -qi "already exists"; then
              echo "PR already exists; skipping create. Message:"
              echo "$OUTPUT"
              exit 0
            fi

            # As a fallback, try to find an open PR for the head.
            EXISTING_URL="$(gh pr list --repo "$REPO" --state open --head "${GITHUB_REPOSITORY_OWNER}:${BRANCH_NAME}" --json url --jq '.[0].url' 2>/dev/null || true)"
            if [ -n "$EXISTING_URL" ]; then
              echo "Found existing PR: $EXISTING_URL"
              exit 0
            fi

            # Otherwise fail and surface the gh output.
            echo "gh pr create failed with exit code $rc" >&2
            echo "$OUTPUT" >&2
            exit $rc
          fi
