name: Auto Create PR

on:
  push:
    branches-ignore:
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-pr:
    name: Create PR On Push
    if: github.actor != 'github-actions[bot]' && github.ref_name != github.event.repository.default_branch
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Create PR if missing
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH_NAME: ${{ github.ref_name }}
          BASE_BRANCH: ${{ github.event.repository.default_branch }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Skip tag pushes.
          if [ "${GITHUB_REF_TYPE}" != "branch" ]; then
            echo "Not a branch push; skipping."
            exit 0
          fi

          HEAD_REF="${GITHUB_REPOSITORY_OWNER}:${BRANCH_NAME}"
          OPEN_PR_NUMBER="$(gh pr list --repo "$REPO" --state open --head "$HEAD_REF" --json number --jq '.[0].number // empty')"

          if [ -n "$OPEN_PR_NUMBER" ]; then
            echo "Open PR already exists: #$OPEN_PR_NUMBER"
            exit 0
          fi

          TITLE="$(git log -1 --pretty=%s)"
          BODY="Automated PR created from push to \\\`$BRANCH_NAME\\\` targeting \\\`$BASE_BRANCH\\\`."

          set +e
          gh pr create \
            --repo "$REPO" \
            --base "$BASE_BRANCH" \
            --head "$BRANCH_NAME" \
            --title "$TITLE" \
            --body "$BODY"
          rc=$?
          set -e
          if [ $rc -ne 0 ]; then
            # If PR already exists, treat as success; otherwise fail.
            if gh pr list --repo "$REPO" --state open --head "${GITHUB_REPOSITORY_OWNER}:${BRANCH_NAME}" --json number --jq '.[0].number // empty' | grep -q .; then
              echo "Open PR already exists; skipping create."
              exit 0
            else
              echo "gh pr create failed with exit code $rc"
              exit $rc
            fi
          fi
